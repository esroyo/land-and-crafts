name: Project PR Pipeline
on:
  issues:
    types: [opened, labeled]

jobs:
  build_project_pr:
    if: contains(github.event.issue.labels.*.name, 'automated-pr')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Process Issue Content
        id: generator
        run: |
          # Capture the body once to avoid expansion issues
          BODY=$(cat << 'EOF'
          ${{ github.event.issue.body }}
          EOF
          )

          # Uses sed to extract lines between headers and
          # another sed to trim leading/trailing whitespace safely.
          get_field() {
            echo "$BODY" | sed -n "/^### $1/,/^###/p" | sed '1d;$d' | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//'
          }

          # Extract Data
          TITLE=$(get_field "Title")
          TAGLINE=$(get_field "Short Tagline")
          COORDS=$(get_field "Coordinates")
          DESCRIPTION=$(get_field "Description")
          MATERIALS=$(get_field "Materials")
          DESIGN=$(get_field "Design Credits")
          MANUFACTURING=$(get_field "Manufacturing Credits")
          LOCATION=$(get_field "Human Readable Location")

          # Extract text before the first comma. If no comma, use the full string.
          LOCATION_FIRST_SEGMENT=$(echo "$LOCATION" | cut -d',' -f1 | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')

          # Slugify Title for Folder Path
          SLUG=$(echo "$TITLE" | iconv -t ascii//TRANSLIT | sed -E 's/[^a-zA-Z0-9]+/-/g' | tr '[:upper:]' '[:lower:]' | sed 's/^-//;s/-$//')
          if [ -z "$SLUG" ]; then
            SLUG="project-${{ github.event.issue.number }}"
          fi
          FOLDER="src/data/projects/$SLUG"
          mkdir -p "$FOLDER"

          # Process Images
          URLS=$(echo '${{ github.event.issue.body }}' | grep -oE 'https://github.com/user-attachments/assets/[a-zA-Z0-9_-]+')
          
          IMG_MD=""
          COUNT=1
          for URL in $URLS; do
            # Fetch the content-type header from GitHub's redirect
            # We use -iL to follow redirects and grab headers
            CTYPE=$(curl -sIL "$URL" | awk -F': ' '/[Cc]ontent-[Tt]ype/ { ctype=$2 } END { gsub(/\r/, "", ctype); print ctype }')
            # Fallback if content-type could not be determined
            if [ -z "$CTYPE" ]; then
              CTYPE="image/jpeg"
            fi

            case "$CTYPE" in
              *"image/png"*)  EXT="png" ;;
              *"image/gif"*)  EXT="gif" ;;
              *"image/webp"*) EXT="webp" ;;
              *"image/svg+xml"*) EXT="svg" ;;
              *) EXT="jpg" ;; # Default/Fallback for image/jpeg
            esac

            NAME="$SLUG-$(printf "%03d" $COUNT).$EXT"
            curl -L -f "$URL" -o "$FOLDER/$NAME"
            
            if [ $COUNT -eq 1 ]; then COVER_FILE="./$NAME"; fi
            IMG_MD="${IMG_MD}![](./$NAME)\n"
            ((COUNT++))
          done

          # Generate index.md
          cat <<EOF > "$FOLDER/index.md"
          ---
          title: $TITLE
          description: "<span><strong>$TITLE, $LOCATION_FIRST_SEGMENT</strong> &mdash; <em>$TAGLINE</em></span>"
          coordinates: $(echo "$COORDS" | sed -E 's/[[:space:]]*,[[:space:]]*/, /g')
          cover: $COVER_FILE
          ---

          ## $TITLE

          $DESCRIPTION

          ### Material

          $MATERIALS

          ### Design

          $DESIGN

          ### Manufacturing

          $MANUFACTURING

          ### Location

          $LOCATION

          <carousel-gallery>

          $(echo -e "$IMG_MD")

          </carousel-gallery>
          EOF

          # 6. Set Outputs for next steps
          echo "slug=$SLUG" >> $GITHUB_OUTPUT
          echo "title=$TITLE" >> $GITHUB_OUTPUT

      - name: Generate Token
        uses: tibdex/github-app-token@v2
        id: generate_token
        with:
          app_id: ${{ secrets.APP_ID }}
          private_key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v5
        with:
          # Use the token from the GitHub App
          token: ${{ steps.generate_token.outputs.token }}
          commit-message: "feat: add project ${{ steps.generator.outputs.slug }}"
          title: "New Project: ${{ steps.generator.outputs.title }}"
          body: |
            Automatic submission from Issue #${{ github.event.issue.number }}.
            
            Closes #${{ github.event.issue.number }}
          branch: "project/${{ steps.generator.outputs.slug }}"
          base: main

      - name: Success Comment
        if: steps.cpr.outputs.pull-request-number
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "âœ… **PR Created!** You can track the progress here: ${{ steps.cpr.outputs.pull-request-url }}. Once merged, this issue will close automatically."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

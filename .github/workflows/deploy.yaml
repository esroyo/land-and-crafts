name: Deploy
on: [push, workflow_dispatch]

jobs:
    deploy:
        name: Deploy
        runs-on: ubuntu-latest
        permissions:
            id-token: write # Needed for auth with Deno Deploy
            contents: read # Needed to clone the repository
            pull-requests: write

        steps:
            - name: Clone repository
              uses: actions/checkout@v4

            - name: Setup deno
              uses: denoland/setup-deno@v2
              with:
                  deno-version: v2.x
                  cache: true

            # Not using npm? Change `npm ci` to `yarn install` or `pnpm i`
            - name: Install dependencies
              run: deno install

            # Not using npm? Change `npm run build` to `yarn build` or `pnpm run build`
            - name: Build Astro
              run: deno task build

            - name: Upload to Deno Deploy
              uses: denoland/deployctl@v1
              with:
                  project: land-and-crafts
                  # entrypoint: dist/server/entry.mjs
                  entrypoint: jsr:@std/http/file-server
                  root: dist/client

            - name: Post Preview Link to PR
              if: github.ref != 'refs/heads/main'
              env:
                GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                # 1. Identify the PR
                PR_NUMBER=$(gh pr view --json number -q .number || echo "")
                if [ -z "$PR_NUMBER" ]; then exit 0; fi

                # 2. Construct the Preview URL
                # Replace slashes in branch name with dashes for Deno URL compatibility
                SAFE_BRANCH=$(echo ${{ github.ref_name }} | sed 's/\//-/g')
                URL="https://land-and-crafts--$SAFE_BRANCH.deno.dev"

                # 3. Create the comment body with a hidden "fingerprint" tag
                COMMENT_BODY="<!-- deploy-preview-comment: land-and-crafts -->
ðŸš€ **Preview Deployment Ready!**

You can view the changes for this submission here:
[$URL]($URL)

_Last updated: $(date -u +'%Y-%m-%d %H:%M:%S') UTC_
"

                # 4. Check for an existing comment by searching for the hidden tag
                EXISTING_COMMENT_ID=$(gh pr view $PR_NUMBER --json comments -q ".comments[] | select(.body | contains(\"<!-- deploy-preview-comment: land-and-crafts -->\")) | .id" | head -n 1)

                if [ -n "$EXISTING_COMMENT_ID" ]; then
                  echo "Updating existing comment $EXISTING_COMMENT_ID..."
                  gh api -X PATCH "repos/${{ github.repository }}/issues/comments/$EXISTING_COMMENT_ID" -f body="$COMMENT_BODY"
                else
                  echo "Creating new comment..."
                  gh pr comment $PR_NUMBER --body "$COMMENT_BODY"
                fi
